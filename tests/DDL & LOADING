CREATE TABLES

IF OBJECT_ID ('bronze.sibanye_doc', 'U') IS NOT NULL
	DROP TABLE bronze.sibanye_doc;
CREATE TABLE bronze.sibanye_doc(
    NO VARCHAR(10),
    REF VARCHAR(50),
    COMPAN_NAME VARCHAR(255),
    ID_NUMBER VARCHAR(50),
    NATURE_OF_BUSINESS VARCHAR(100),
    AREA VARCHAR(100),
    MUNICIPALITY VARCHAR(100),
    VENDOR_NUMBER VARCHAR(50),
    ATTENDEE_INITIALS VARCHAR(20),
    ATTENDEE_SURNAME VARCHAR(100),
    BYO VARCHAR(20),
    BWO VARCHAR(20),
    BDO VARCHAR(20),
    BEE_LEVEL VARCHAR(20),
    ED VARCHAR(20),
    SD VARCHAR(20),
    MODULE_1 VARCHAR(20),
    MODULE_2 VARCHAR(20),
    MODULE_3 VARCHAR(20),
    MODULE_4 VARCHAR(20),
    MODULE_5 VARCHAR(20),
    MODULE_6 VARCHAR(20),
    EMAIL VARCHAR(255),
    CONTACT_NUMBER VARCHAR(50),
    CLIENT VARCHAR(100),
    HUB VARCHAR(100),
    PROGRAM_TYPE VARCHAR(100),
    PROGRAM_NM VARCHAR(255)
);


--- LOAD TABLES
CREATE OR ALTER PROCEDURE bronze.load_bronze AS
    BEGIN
        DECLARE @start_time DATETIME, @end_time DATETIME, @batch_start_time DATETIME, @batch_end_time DATETIME
	    BEGIN TRY
		    SET @batch_start_time = GETDATE();
            PRINT '============================================================';
            PRINT 'Loading Bronze Layer';
            PRINT '============================================================';

            PRINT '------------------------------------------------------------';
            PRINT 'Loading Sibanye Tables';
            PRINT '------------------------------------------------------------';

            PRINT '>> Truncating Table bronze.sibanye_doc'
            TRUNCATE TABLE bronze.sibanye_doc;

            PRINT '>> Inserting Data Into: Table bronze.sibanye_doc'
            BULK INSERT bronze.sibanye_doc
            FROM 'C:\Users\sbu_2\Documents\sibanye\sibanye.cvs.txt'
            WITH (
                FIELDTERMINATOR = ';',
                ROWTERMINATOR = '\n',
                FIRSTROW = 2,
                CODEPAGE = '65001',
                TABLOCK
            );
    		        SET @end_time = GETDATE();
	        PRINT '>> Load Duration: ' + CAST(DATEDIFF(SECOND, @start_time, @end_time) AS NVARCHAR) + 'seconds';
	        PRINT '---------------------------------'

	        SET @batch_end_time = GETDATE();
	        PRINT '=================================='
	        PRINT 'Loading Silver Layer';
	        PRINT '  - Total loading Duration: ' + CAST(DATEDIFF(SECOND, @batch_start_time, @batch_end_time) AS NVARCHAR) + 'seconds';
	        PRINT '=================================='

	    END TRY
	    BEGIN CATCH
		    PRINT '==================================='
		    PRINT 'Error Occured During Loading bronze Layer'
		    PRINT 'Error Massage' + ERROR_MESSAGE();
		    PRINT 'Error Massage' + CAST(ERROR_NUMBER() AS NVARCHAR);
		    PRINT 'Error Massage' + CAST(ERROR_STATE() AS NVARCHAR);
		    PRINT '==================================='
	    END CATCH
    END


--- CLEAN AND LOAD SILVER TABLE
TRUNCATE TABLE silver.sibanye_doc;
INSERT INTO silver.sibanye_doc(
NO,REF,
COMPANY_NAME, ID_NUMBER, NATURE_OF_BUSINESS,
AREA, MUNICIPALITY, VENDOR_NUMBER, ATTENDEE_INITIALS, ATTENDEE_SURNAME,
BYO, BWO, BDO, BEE_LEVEL, ED, SD,
MODULE_1, MODULE_2, MODULE_3, MODULE_4, MODULE_5, MODULE_6,
EMAIL, CONTACT_NUMBER, CLIENT, HUB,
PROGRAM_TYPE,
PROGRAM_NM
)

SELECT 
    NO,
    REF,
    UPPER(TRIM(COMPAN_NAME)) AS COMPANY_NAME,

    CASE  WHEN LEN(ID_NUMBER) = 13 AND ID_NUMBER LIKE '%[0-9]%'
             THEN ID_NUMBER
          ELSE NULL
    END AS ID_NUMBER,

    UPPER(TRIM(NATURE_OF_BUSINESS)) AS NATURE_OF_BUSINUSS,
    UPPER(TRIM(AREA)) AS AREA,
    TRIM(MUNICIPALITY) AS MUNICIPALITY,
    TRIM(VENDOR_NUMBER) AS VENDOR_NUMBER,
    UPPER(TRIM(ATTENDEE_INITIALS)) AS ATTENDEE_INITIALS,
    UPPER(TRIM(ATTENDEE_SURNAME))AS ATENDEE_SURNAME,
    BYO, BWO, BDO, BEE_LEVEL, ED, SD,
    MODULE_1, MODULE_2, MODULE_3, MODULE_4, MODULE_5, MODULE_6,

    CASE 
        WHEN EMAIL LIKE 'dmnmouthriverprojects@gmailcom'
        THEN REPLACE(TRIM(EMAIL), '@gmailcom', '@gmail.com')
        ELSE EMAIL
    END AS EMAIL,

    CASE WHEN LEN(CONTACT_NUMBER) = 10 AND CONTACT_NUMBER LIKE '%[0-9]%'
             THEN CONTACT_NUMBER
         ELSE NULL
    END AS CONTACT_NUMBER,

    UPPER(TRIM(CLIENT)) AS CLIENT,
    UPPER(TRIM(HUB)) AS HUB,
    UPPER(TRIM(PROGRAM_TYPE)) AS PROGRAM_TYPE,
    UPPER(TRIM(PROGRAM_NM)) AS PROGRAM_NM
FROM (
    SELECT *,
           ROW_NUMBER() OVER (PARTITION BY ID_NUMBER, PROGRAM_NM ORDER BY NO) AS rn
    FROM bronze.sibanye_doc
)t
WHERE rn = 1;

--- CATCH AND DIAGNOSTIC SCRIPTS
--catch duplicates
SELECT ID_NUMBER, PROGRAM_NM, COUNT(*)
FROM silver.sibanye_doc
GROUP BY ID_NUMBER, PROGRAM_NM, REF
HAVING COUNT(*) > 1

--Find missing and NULL values
SELECT * FROM bronze.sibanye_doc
WHERE IS NULL

--Find invalid values i.e dates or telephone numbers or dates emails
--1, negative values
SELECT * FROM bronze.sibanye_doc
WHERE REPLACE(BYO, '%', '') < 0 OR REPLACE(BWO, '%', '') < 0 OR REPLACE(BYO, '%', '') < 0 OR REPLACE(BEE_LEVEL, '%', '') < 0 

--2.A, INACURATE ID
SELECT * FROM bronze.sibanye_doc
WHERE LEN(ID_NUMBER) != 13 OR ID_NUMBER NOT LIKE '%[0-9]%'
--B, CONTACT_NUMBER
SELECT * FROM bronze.sibanye_doc
WHERE LEN(CONTACT_NUMBER) != 10 OR CONTACT_NUMBER NOT LIKE '0%'
--C, EMAIL
SELECT * FROM bronze.sibanye_doc
WHERE EMAIL NOT LIKE '%_@_%._%';
--D, DATE
SELECT *
FROM(SELECT 
    MODULE_6,
    CASE 
        WHEN TRY_CAST(MODULE_6 AS DATE) > GETDATE() THEN 'Invalid'
        ELSE 'Valid'
    END AS DateQuality
FROM bronze.sibanye_doc)t 
WHERE DateQuality = 'Invalid'
