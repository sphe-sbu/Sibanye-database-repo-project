CREATE TABLES

IF OBJECT_ID ('bronze.sibanye_doc', 'U') IS NOT NULL
	DROP TABLE bronze.sibanye_doc;
CREATE TABLE bronze.sibanye_doc(
    NO VARCHAR(10),
    REF VARCHAR(50),
    COMPAN_NAME VARCHAR(255),
    ID_NUMBER VARCHAR(50),
    NATURE_OF_BUSINESS VARCHAR(100),
    AREA VARCHAR(100),
    MUNICIPALITY VARCHAR(100),
    VENDOR_NUMBER VARCHAR(50),
    ATTENDEE_INITIALS VARCHAR(20),
    ATTENDEE_SURNAME VARCHAR(100),
    BYO VARCHAR(20),
    BWO VARCHAR(20),
    BDO VARCHAR(20),
    BEE_LEVEL VARCHAR(20),
    ED VARCHAR(20),
    SD VARCHAR(20),
    MODULE_1 VARCHAR(20),
    MODULE_2 VARCHAR(20),
    MODULE_3 VARCHAR(20),
    MODULE_4 VARCHAR(20),
    MODULE_5 VARCHAR(20),
    MODULE_6 VARCHAR(20),
    EMAIL VARCHAR(255),
    CONTACT_NUMBER VARCHAR(50),
    CLIENT VARCHAR(100),
    HUB VARCHAR(100),
    PROGRAM_TYPE VARCHAR(100),
    PROGRAM_NM VARCHAR(255)
);


--- LOAD TABLES
CREATE OR ALTER PROCEDURE bronze.load_bronze AS
    BEGIN
        DECLARE @start_time DATETIME, @end_time DATETIME, @batch_start_time DATETIME, @batch_end_time DATETIME
	    BEGIN TRY
		    SET @batch_start_time = GETDATE();
            PRINT '============================================================';
            PRINT 'Loading Bronze Layer';
            PRINT '============================================================';

            PRINT '------------------------------------------------------------';
            PRINT 'Loading Sibanye Tables';
            PRINT '------------------------------------------------------------';

            PRINT '>> Truncating Table bronze.sibanye_doc'
            TRUNCATE TABLE bronze.sibanye_doc;

            PRINT '>> Inserting Data Into: Table bronze.sibanye_doc'
            BULK INSERT bronze.sibanye_doc
            FROM 'C:\Users\sbu_2\Documents\sibanye\sibanye.cvs.txt'
            WITH (
                FIELDTERMINATOR = ';',
                ROWTERMINATOR = '\n',
                FIRSTROW = 2,
                CODEPAGE = '65001',
                TABLOCK
            );
    		        SET @end_time = GETDATE();
	        PRINT '>> Load Duration: ' + CAST(DATEDIFF(SECOND, @start_time, @end_time) AS NVARCHAR) + 'seconds';
	        PRINT '---------------------------------'

	        SET @batch_end_time = GETDATE();
	        PRINT '=================================='
	        PRINT 'Loading Silver Layer';
	        PRINT '  - Total loading Duration: ' + CAST(DATEDIFF(SECOND, @batch_start_time, @batch_end_time) AS NVARCHAR) + 'seconds';
	        PRINT '=================================='

	    END TRY
	    BEGIN CATCH
		    PRINT '==================================='
		    PRINT 'Error Occured During Loading bronze Layer'
		    PRINT 'Error Massage' + ERROR_MESSAGE();
		    PRINT 'Error Massage' + CAST(ERROR_NUMBER() AS NVARCHAR);
		    PRINT 'Error Massage' + CAST(ERROR_STATE() AS NVARCHAR);
		    PRINT '==================================='
	    END CATCH
    END

